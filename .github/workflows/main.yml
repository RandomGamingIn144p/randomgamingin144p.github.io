name: browservice thing

on: [push, workflow_dispatch]

defaults:
  run:
    shell: bash

jobs:
  browservice_job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Installing node.js and npm...
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Installing localtunnel...
        run: npm install -g localtunnel

      - name: Starting localtunnel and getting url...
        id: localtunnel_setup
        run: |
          lt --port 80 2>&1 | tee localtunnel_output.txt &
          sleep 10
          BROWSERVICE_URL=$(grep -oP 'your url is: \K(https?://[^\s]+)' localtunnel_output.txt | head -n 1)
          if [ -z "$BROWSERVICE_URL" ]; then
            cat localtunnel_output.txt
            exit 1
          fi
          echo "::set-output name=browservice_url::$BROWSERVICE_URL"

      - name: Install and Configure Browservice
        run: |
          BROWSERVICE_DOWNLOAD_URL="https://github.com/ttalvitie/browservice/releases/download/v0.9.11.1/browservice-v0.9.11.1-x86_64.AppImage"
          curl -k -O "$BROWSERVICE_DOWNLOAD_URL"
	  chmod +x browservice-v.0.9.11.1-x64_64.AppImage
	  ./browservice-v.0.9.11.1-x86_64.AppImage

      - name: Keep alive
        run: sleep infinity
